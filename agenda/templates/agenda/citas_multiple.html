{% extends "base.html" %}
{% load i18n static rest_framework common_tags %}

{% block imports %}
    <link rel="import" href="/static/bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
    <link rel="import" href="/static/bower_components/vaadin-combo-box/vaadin-combo-box.html">
    <link rel="import" href="/static/bower_components/paper-dialog/paper-dialog.html">
    <link rel="import" href="/static/bower_components/paper-button/paper-button.html">
    <link rel="import" href="/static/bower_components/iron-ajax/iron-ajax.html">
    <link rel="import" href="/static/bower_components/iron-form/iron-form.html">
    <link rel="import" href="/static/bower_components/scheduler-component/scheduler-component.html">
    <link rel="import" href="/static/components/form-cita.html">
    <link rel="import" href="/static/components/agenda-multiple.html">
{% endblock imports %}

{% block content %}
    <header class="header-title">
        <h1>{% trans "agendar citas" %}</h1>
    </header>

    <div class="card">
        <iron-ajax id="save-event-request" url="{% url "agenda:citas" %}" method="POST" handle-as="json"
                content-type="application/json"></iron-ajax>

        <agenda-multiple id="agenda"></agenda-multiple>
        <!-- <scheduler-component default-view="agendaWeek" selectable></scheduler-component> -->
    </div>
{% endblock content %}

{% block dialogs %}
    <form-cita tipos-documento='{{ form.fields.paciente.tipo_documento|to_json }}' 
        paciente-info-url="{% url 'agenda:persona-search' %}" new-cita-url="{% url 'agenda:citas' %}"
        servicios='{{ form.fields.servicio|to_json }}' estados='{{ form.fields.estado|to_json }}' 
        >
    </form-cita>
{% endblock dialogs %}

{% block js %}
    <script src="{% static 'bower_components/jquery/dist/jquery.min.js' %}"></script>
    <script src="{% static 'bower_components/moment/min/moment.min.js' %}"></script>
    <script src="{% static 'bower_components/fullcalendar/dist/fullcalendar.min.js' %}"></script>
    <script src="{% static 'bower_components/fullcalendar/dist/locale/es.js' %}"></script>
    <script src="{% static 'js/utils.js' %}"></script>

    <script>
        (function() {
            const agenda = document.getElementById('agenda');
            const citaDialog = document.querySelector('form-cita');

            agenda.addEventListener('disponible-click', function(e) {
                console.log('nueva cita');
                citaDialog.nuevaCita(e.detail.event);
            });

            agenda.addEventListener('cita-click', function(e) {
                console.log('ver cita');
                citaDialog.verCita(_normalizeCita(e.detail.cita));
            });

            citaDialog.addEventListener('cita-saved', function(e) {
                console.log('cita guardada');
                if (e.detail.redirecciona) {
                    window.location = e.detail.redirecciona_link;
                }
                else {
                    agenda.refecthCitas();
                }
            });

            /** @todo integrar graphql en el forulario */
            function _normalizeCita(cita) {
                return {
                    id: cita.id,
                    start: cita.start,
                    end: cita.end,
                    servicio: cita.servicio.pk,
                    estado: cita.estado,
                    paciente: {
                        numero_documento: cita.paciente.numeroDocumento,
                        tipo_documento: cita.paciente.tipoDocumento,
                        primer_nombre: cita.paciente.primerNombre,
                        segundo_nombre: cita.paciente.segundoNombre,
                        primer_apellido: cita.paciente.primerApellido,
                        segundo_apellido: cita.paciente.segundoApellido,
                        telefono: cita.paciente.telefono,
                        celular: cita.paciente.celular,
                        direccion: cita.paciente.direccion
                    }
                };
            }
        })();        
    </script>
{% endblock js %}
<link rel="import" href="/static/bower_components/polymer/polymer-element.html">

<link rel="import" href="/static/bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="/static/bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="/static/bower_components/paper-button/paper-button.html">
<link rel="import" href="/static/bower_components/iron-form/iron-form.html">
<link rel="import" href="/static/bower_components/paper-input/paper-input.html">
<link rel="import" href="/static/bower_components/apollo-client/graphql-query.html">
<link rel="import" href="/static/bower_components/vaadin-material-theme/vaadin-date-picker.html">
<link rel="import" href="/static/bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="/static/bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="/static/bower_components/show-json/show-json.html">

<link rel="import" href="/static/bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="/static/bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="/static/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/static/bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="/static/bower_components/iron-list/iron-list.html">
<link rel="import" href="/static/bower_components/paper-item/paper-item.html">
<link rel="import" href="/static/my-icons.html">


<dom-module id="servicio-form">
    <template>
        <style>
            :host {
                display: block
            }

            paper-dialog {
                width: 60%;
            }

            .row {
                display: flex;
                align-items: flex-end;
            }
            
            .row > * {
                flex: 1;
                margin-right: 10px;
            }

            .row:nth-last-child(2) paper-input:first-child {
                flex: 0 1 auto;
            }
        </style>

        <graphql-query id="query" variables="[[_queryVariables(institucion, plan)]]" result="{{queryResult}}">
            query servicioFormData($plan: ID, $institucion: ID){
                servicios(planes: [$plan]) {
                    edges {
                        node {
                            id
                            nombre
                            tarifas(plan: $plan) {
                                edges {
                                    node {
                                        valor
                                    }
                                }
                            }
                        }
                    }
                }
                medicos(instituciones: [$institucion]) {
                    edges {
                        node {
                            id
                            nombreCompleto
                        }
                    }
                }
                sucursales {
                    edges {
                        node {
                            id
                            nombre
                        }
                    }
                }
            }
        </graphql-query>

        <graphql-query id="citaQuery" hold>
            query citaInfo($id: ID!) {
                cita(id: $id) {
                    id
                    start
                    estado
                    estadoDisplay
                    servicio {
                      id
                    }
                    horario {
                      sucursal {
                        id
                      }
                      medico {
                        id
                      }
                    }
                }
            }
        </graphql-query>

        <paper-dialog modal id="dialog">
            <h2>Nuevo Servicio</h2>

            <paper-dialog-scrollable>
                <iron-form id="form">
                    <form>
                        <div class="row">
                            <vaadin-combo-box label="Sucursal*" required items="[[queryResult.sucursales.edges]]"  
                                auto-validate value="[[value.sucursal]]" selected-item="{{value.sucursalItem}}"
                                item-label-path="node.nombre" item-value-path="node.id">
                            </vaadin-combo-box>
                            <vaadin-combo-box label="Medico*" required items="[[queryResult.medicos.edges]]"
                                auto-validate value="[[value.medico]]" selected-item="{{value.medicoItem}}"
                                item-label-path="node.nombreCompleto" item-value-path="node.id" allow-custom-value>
                            </vaadin-combo-box>
                        </div>
                        <div class="row">
                            <vaadin-combo-box label="Servicio*" required items="[[queryResult.servicios.edges]]" 
                                auto-validate value="[[value.servicio]]" selected-item="{{value.servicioItem}}"
                                item-label-path="node.nombre" item-value-path="node.id" allow-custom-value>
                            </vaadin-combo-box>
                        </div>
                        <div class="row">
                            <vaadin-date-picker id="fecha" label="Fecha*" required auto-validate value="{{value.fecha}}">
                            </vaadin-date-picker>
                            <paper-input type="time" label="Hora*" required value="{{value.hora}}"></paper-input>
                        </div>
                        <div class="row">
                            <paper-input label="Autorización" value="{{value.autorizacion}}"></paper-input>
                            <vaadin-date-picker name="fecha_autorizacion" label="Fecha autorización" 
                                value="{{value.fechaAutorizacion}}">
                            </vaadin-date-picker>
                        </div>
                        <div class="row">
                            <paper-input label="# de sesiones*" type="number" required 
                                auto-validate min="1" value="{{value.numeroSesiones}}">
                            </paper-input>
                            <paper-input label="Valor de la sesión*" type="number" required readonly
                                auto-validate min="0" value="{{value.valor}}">
                            </paper-input>
                        </div>
                        <div class="row">
                            <paper-input label="Valor total*" type="number" auto-validate min="0" readonly
                                value="{{value.total}}" required>
                            </paper-input>
                            <paper-input label="Coopago/Moderadora*" type="number" auto-validate min="0" 
                                value="{{value.coopago}}" required>
                            </paper-input>
                        </div>          
                    </form>
                </iron-form>
                <!-- <show-json json="[[value]]"></show-json> -->
            </paper-dialog-scrollable>

            <div class="buttons">
                <paper-button dialog-dismiss>Cancelar</paper-button>
                <paper-button on-tap="add">Agregar</paper-button>
            </div>
        </paper-dialog>

    </template>
</dom-module>

<dom-module id="servicios-orden">
    <template>
        <style>
            :host {
                display: block;
                border: 1px solid #e8e8e8;
            }

            .grid {
                display: grid;
                grid-template-columns: 20% 1fr;
                grid-template-rows: 20% 1fr;
                grid-template-areas: 
                "servicios servicio-info"
                "servicios sesiones";
                box-sizing: border-box;
                height: 540px;
            }

            .grid [invalid] {
                color: var(--error-color, red) !important;
            }

            .servicios {
                grid-area: servicios;
                display: flex;
                flex-direction: column;
                border-right: 1px solid #e8e8e8;
            }

            .servicios app-toolbar {
                border-bottom: 1px solid #e8e8e8;
            }

            .servicios iron-list {
                flex: 1;
            }

            .servicios iron-list paper-item {
                border-bottom: 1px solid #e8e8e8;
            }

            .servicios iron-list paper-item[selected] {
                background-color: #e4e2e2;
                font-weight: bold;
                color: #3e3c3c;
            }

            .servicio-info {
                grid-area: servicio-info;
                display: grid;
                grid-template: 1fr 1fr / 1fr 1fr 1fr;
                border-bottom: 1px solid #e8e8e8;
                padding: 5px;
            }

            .sesiones {
                grid-area: sesiones;
                padding: 5px;
            }
        </style>

        <graphql-query id="query" variables="[[_queryVariables(institucion)]]" result="{{queryResult}}">
            query sesionForm($institucion: ID){
                medicos(instituciones: [$institucion]) {
                    edges {
                        node {
                            id
                            nombreCompleto
                        }
                    }
                }
                sucursales {
                    edges {
                        node {
                            id
                            nombre
                        }
                    }
                }
            }
        </graphql-query>
        <!-- <div style="display: flex">
            <show-json json="[[editingSesion]]"></show-json>
            <show-json json="[[sesionValue]]"></show-json>
        </div>         -->
        <div class="grid">
            <div class="servicios">
                <app-toolbar>
                    <paper-icon-button icon="my-icons:add" on-tap="_addServicio"></paper-icon-button>
                </app-toolbar>
                <iron-list id="serviciosList" items="[[servicios]]" selection-enabled selected-item="{{selectedServicio}}">
                    <template>
                        <paper-item selected$="[[selected]]" invalid$="[[item.node.invalid]]">
                            [[item.node.servicio.nombre]]
                            <paper-icon-button icon="my-icons:delete" on-tap="_deleteServicio"></paper-icon-button>
                        </paper-item>
                    </template>
                </iron-list>
            </div>
            <div class="servicio-info">
                <p><b>Numero de sesiones:</b> [[selectedServicio.node.numeroSesiones]]</p>
                <p><b>Cumplidas:</b> [[selectedServicio.node.sesionesCumplidas]]</p>
                <p><b>Pendientes:</b> [[_calcularSesionesPendientes(selectedServicio.node.numeroSesiones, selectedServicio.node.sesionesCumplidas)]]</p>
                <p><b>Valor de la sesión:</b> [[_formatCurrency(selectedServicio.node.valor)]]</p>
                <p><b>Total:</b> [[_calcularTotal(selectedServicio.node.numeroSesiones, selectedServicio.node.valor)]]</p>
                <p><b>Coopago/Cuota Moderadora:</b> [[_formatCurrency(selectedServicio.node.coopago)]]</p>
            </div>
            <div class="sesiones">
                <vaadin-grid id="grid" items="[[selectedServicio.node.sesiones.edges]]">
                    <vaadin-grid-column resizable width="174px">
                        <template class="header">Fecha</template>
                        <template>
                            <span hidden="[[_isEditingSesion(editingSesion, item)]]" invalid$="[[item.node.invalid]]">
                                [[_formatFecha(item.node.fecha)]]
                            </span>
                            <paper-input type="date" value="{{sesionValue.fecha}}" 
                                hidden="[[!_isEditingSesion(editingSesion, item)]]">
                            </paper-input>
                        </template>
                    </vaadin-grid-column>
                    <vaadin-grid-column resizable width="128px">
                        <template class="header">Hora</template>
                        <template>
                            <span hidden="[[_isEditingSesion(editingSesion, item)]]" invalid$="[[item.node.invalid]]">
                                [[_formatHora(item.node.fecha)]]
                            </span>
                            <paper-input type="time" value="{{sesionValue.hora}}"
                                hidden="[[!_isEditingSesion(editingSesion, item)]]">
                            </paper-input>
                        </template>
                    </vaadin-grid-column>
                    <vaadin-grid-column resizable width="216px">
                        <template class="header">Estado</template>
                        <template>
                            <span hidden="[[_isEditingSesion(editingSesion, item)]]" invalid$="[[item.node.invalid]]">
                                [[item.node.estadoDisplay]]
                            </span>
                            <span hidden="[[!_isEditingSesion(editingSesion, item)]]">
                                <vaadin-combo-box items="[[estados]]" value="[[sesionValue.estado]]"
                                    selected-item="{{sesionValue.estadoItem}}"></vaadin-combo-box>
                            </span>
                        </template>
                    </vaadin-grid-column>
                    <vaadin-grid-column resizable width="235px">
                        <template class="header">Medico</template>
                        <template>
                            <span hidden="[[_isEditingSesion(editingSesion, item)]]" invalid$="[[item.node.invalid]]">
                                [[item.node.medico.nombreCompleto]]
                            </span>
                            <span hidden="[[!_isEditingSesion(editingSesion, item)]]">
                                <vaadin-combo-box items="[[queryResult.medicos.edges]]" item-value-path="node.id"
                                    item-label-path="node.nombreCompleto" value="[[sesionValue.medico]]"
                                    selected-item="{{sesionValue.medicoItem}}">
                                </vaadin-combo-box>
                            </span>
                        </template>
                    </vaadin-grid-column>
                    <vaadin-grid-column resizable>
                        <template class="header">Autorización</template>
                        <template>
                            <span hidden="[[_isEditingSesion(editingSesion, item)]]" invalid$="[[item.node.invalid]]">
                                [[item.node.autorizacion]]
                            </span>
                            <paper-input hidden="[[!_isEditingSesion(editingSesion, item)]]"
                                value="{{sesionValue.autorizacion}}"></paper-input>
                        </template>
                    </vaadin-grid-column>
                    <vaadin-grid-column resizable width="185px">
                        <template class="header">Fecha Autorización</template>
                        <template>
                            <span hidden="[[_isEditingSesion(editingSesion, item)]]" invalid$="[[item.node.invalid]]">
                                [[item.node.fechaAutorizacion]]
                            </span>
                            <paper-input type="date" hidden="[[!_isEditingSesion(editingSesion, item)]]"
                                value="{{sesionValue.fechaAutorizacion}}"></paper-input>
                        </template>
                    </vaadin-grid-column>
                    <vaadin-grid-column resizable width="170px">
                        <template class="header">Sucursal</template>
                        <template>
                            <span hidden="[[_isEditingSesion(editingSesion, item)]]" invalid$="[[item.node.invalid]]">
                                [[item.node.sucursal.nombre]]
                            </span>
                            <span hidden="[[!_isEditingSesion(editingSesion, item)]]">
                                <vaadin-combo-box items="[[queryResult.sucursales.edges]]" item-value-path="node.id"
                                    item-label-path="node.nombre" value="[[sesionValue.sucursal]]"
                                    selected-item="{{sesionValue.sucursalItem}}">
                                </vaadin-combo-box>
                            </span>
                        </template>
                    </vaadin-grid-column>
                    <vaadin-grid-column flex-grow="0">
                        <template>
                            <div style="display: flex;">
                                <paper-icon-button icon="my-icons:edit" on-tap="_editSesion" hidden="[[editingSesion]]"></paper-icon-button>
                                <paper-icon-button icon="my-icons:done" on-tap="_saveEditedSesion" hidden="[[!_isEditingSesion(editingSesion, item)]]"></paper-icon-button>
                                <paper-icon-button icon="my-icons:close" on-tap="_cancelEditSesion" hidden="[[!_isEditingSesion(editingSesion, item)]]">
                                </paper-icon-button>
                            </div>
                        </template>
                    </vaadin-grid-column>
                </vaadin-grid>
            </div>
        </div>
    </template>

</dom-module>

<script src="/static/bower_components/moment/min/moment.min.js"></script>
<script>
    (function() {

        let servicioFormInstance = null;

        /**
         * `servicio-form` Formulario para agregar un servicio a una orden.
         *
         * @customElement
         * @polymer
         * @extends {Polymer.Element}
         */
         class ServicioForm extends Polymer.Element {
            /**
             * String providing the tag name to register the element under.
             */
            static get is() {
                return 'servicio-form';
            }

            /**
            * Emitido cuando el formulario es valido y se presiona el boton Agregar.
            *
            * @param {Param} data Datos del servicio a agregar.
            * @event add-servicio
            */

            /**
             * Object describing property-related metadata used by Polymer features
             */
            static get properties() {
                return {
                    /**
                     * Filtra los medicos permitidos a escoger.
                     */
                    institucion: {
                        type: String,
                        value: ''
                    },

                    /**
                     * Filtra los servicios permitidos a escoger.
                     */
                    plan: {
                        type: String,
                        value: ''
                    },

                    /**
                     * Id de la cita, usada para llenar el formulario.
                     */
                    cita: {
                        type: String,
                        value: '',
                        observer: '_citaChanged'
                    },

                    /**
                     * Valores iniciales del formulario.
                     */
                     _initialValue: {
                        type: Object,
                        value: () => {
                            return {
                                numeroSesiones: 1,
                                fecha: moment().format('YYYY-MM-DD'),
                                hora: moment().format('HH:mm')
                            }
                        }
                    },

                    /**
                     * Datos del formulario.
                     *
                     * @type {{sucursal: string, sucursalItem: Object, medico: string, medicoItem: Object, servicio: string, servicioItem: Object, fecha: string, hora: string, autorizacion: string, fechaAutorizacion: string, numeroSesiones: number, valor: number, total: number, coopago: number}}
                     */
                    value: {
                        type: Object,
                        value: () => { 
                            return {
                                numeroSesiones: 1,
                                fecha: moment().format('YYYY-MM-DD'),
                                hora: moment().format('HH:mm')
                            }
                        }
                    }
                };
            }

            /**
              * Array of strings describing multi-property observer methods and their
              * dependant properties
              */
            static get observers() {
                return [
                    '_cleanNumberValues(value.numeroSesiones, value.valor, valor.total, value.coopago)',
                    '_calcularTotal(value.numeroSesiones, value.valor)',
                    '_setFieldValorServicio(value.servicioItem)'
                ];
            }

            /**
             * Instance of the element is created/upgraded. Use: initializing state,
             * set up event listeners, create shadow dom.
             * @constructor
             */
            constructor() {
                super();
                if (!servicioFormInstance) servicioFormInstance = this;
            }

            /**
             * Use for one-time configuration of your component after local DOM is initialized. 
             */
            ready() {
                super.ready();
            
                // When possible, use afterNextRender to defer non-critical
                // work until after first paint.
                Polymer.RenderStatus.afterNextRender(this, function() {
                    this.$.fecha.min = moment().format('YYYY-MM-DD');
                });
            
            }

            /**
            * Observer method for cita property. Executes citaInfo query and fill form data.
            */
            _citaChanged(newValue, oldValue) {      
                console.log(newValue);
                if(newValue) {
                    this.$.citaQuery.variables = {id: newValue};
                    this.$.citaQuery.execute().result().then(result => {
                        let cita = result.data.cita;
                        this.set('value.sucursal', cita.horario.sucursal.id);
                        this.set('value.medico', cita.horario.medico.id);
                        this.set('value.servicio', cita.servicio.id);
                        this.set('value.fecha', moment.utc(cita.start).format('YYYY-MM-DD'));
                        this.set('value.hora', moment.utc(cita.start).format('HH:mm'));
                        this.set('value.cita', this.cita);
                        this.set('value.estado', cita.estado);
                        this.set('value.estadoDisplay', cita.estadoDisplay);
                    });
                }
            }

            /**
            * Normaliza las variables en un objecto para ser usadas en graphql query
            * 
            * @param {string} institucion institucion escogida
            * @param {string} plan plan escogido
            * @return {{institucion: string, plan: string}} Objeto para ser usado en query
            */
            _queryVariables(institucion, plan) {
                return { institucion, plan };
            }

            /**
            * Normaliza a null los valores numericos cuando estan vacios.
            * 
            * @param {number} numeroSesiones Valor del input numeroSesiones
            * @param {number} valor Valor del input valor 
            * @param {number} total Valor del input total 
            * @param {number} coopago Valor del input coopago 
            */
            _cleanNumberValues(numeroSesiones, valor, total, coopago) {
                if (numeroSesiones == '') {
                    this.set('value.numeroSesiones', null);
                }

                if (valor == '') {
                    this.set('value.valor', null);
                }

                if (total == '') {
                    this.set('value.total', null);
                }

                if (coopago == '') {
                    this.set('value.coopago', null);
                }
                else {
                    this.set('value.coopago', Number(coopago));
                }
            }

            /**
            * Setea el valor por sesion de acuerdo al servicio escogido.
            * 
            * @param {object} servicio Servicio escogido
            */
            _setFieldValorServicio(servicio) {
                if (servicio) {
                    this.set('value.valor', servicio.node.tarifas.edges[0].node.valor);
                }
            }

            /**
            * Calcula el valor total de acuerdo al número de sesiones y el valor de la sesión.
            * 
            * @param {number} cantidad Número de sesiones
            * @param {number} valor valor de la sesión
            */
            _calcularTotal(cantidad, valor) {
                if (cantidad && valor) {
                    this.set('value.total', cantidad*valor);
                }
                else {
                    this.set('value.total', null);
                }
            }

            /** Muestra el formulario. */
            open() {
                this.$.dialog.open();
            }

            /** Oculta el formulario. */
            close() {
                this.$.dialog.close();
            }

            /** Limpia el formulario. */
            clean() {
                this._initialValue.autorizacion = this.value.autorizacion;
                this._initialValue.fechaAutorizacion = this.value.fechaAutorizacion;
                this.value = JSON.parse(JSON.stringify(this._initialValue));
                this.cita = '';
            }

            /**
            * Valida el formulario
            * 
            * @returns {boolean} True si el formulario es valido, false si es invalido.
            */
            validate() {
                return this.$.form.validate();
            }

            /**
            * Verifica que el formulario sea valido y notifica si se debe agregar un nuevo servicio.
            */
            add() {
                if (this.validate()) {
                    this.close();
                    this.dispatchEvent(new CustomEvent('add-servicio', {
                        detail: { data: this.value }
                    }));
                    this.clean();
                }
            }            

        }

        window.customElements.define(ServicioForm.is, ServicioForm);

        /**
         * `servicios-orden` Muestra los servicios de una orden.
         *
         * @customElement
         * @polymer
         * @extends {Polymer.Element}
         */
         class ServiciosOrden extends Polymer.Element {
            /**
             * String providing the tag name to register the element under.
             */
            static get is() {
                return 'servicios-orden';
            }

            /**
             * Object describing property-related metadata used by Polymer features
             */
            static get properties() {
                return {
                    /**
                     * Servicios a realizar en la orden.
                     */
                    servicios: {
                        type: Array,
                        value: () => { return []; }
                    },

                    /**
                     * Servicio seleccionado de la lista de servicios.
                     */
                    selectedServicio: {
                        type: Object,
                        value: () => { return {}; }
                    },

                    /**
                     * Sesión a editar.
                     */
                    editingSesion:  {
                        type: Object,
                        value: () => { return null; }
                    },

                     /**
                     * Datos editados
                     */
                     sesionValue:  {
                        type: Object,
                        value: () => { return null; }
                    },

                    /**
                     * Estados de las sesiones.
                     */
                    estados: {
                        type: Array,
                        value: () => { 
                            return [
                                {label: 'No confirmada', value: 'NC'},
                                {label: 'Confirmada', value: 'CO'},
                                {label: 'Cumplida', value: 'CU'},
                                {label: 'Cancelada', value: 'CA'},
                                {label: 'Excusada', value: 'EX'},
                                {label: 'No asistio', value: 'NA'},
                            ];
                        }
                    },

                    /**
                     * Filtra los medicos permitidos a escoger.
                     */
                     institucion: {
                        type: String,
                        value: ''
                    }
                };
            }

            /**
             * Instance of the element is created/upgraded. Use: initializing state,
             * set up event listeners, create shadow dom.
             * @constructor
             */
            constructor() {
                super();
                this._boundAddServicioListener = this._addServicioListener.bind(this);
            }

            /**
              * Called every time the element is inserted into the DOM. Useful for 
              * running setup code, such as fetching resources or rendering.
              * Generally, you should try to delay work until this time.
              */
            connectedCallback() {
                super.connectedCallback();
                servicioFormInstance.addEventListener('add-servicio', this._boundAddServicioListener);
            }

            /**
              * Called every time the element is removed from the DOM. Useful for 
              * running clean up code (removing event listeners, etc.).
              */
            disconnectedCallback() {
                super.disconnectedCallback();
                servicioFormInstance.removeEventListener('add-servicio', this._boundAddServicioListener);
            }

            /**
             * Use for one-time configuration of your component after local DOM is initialized. 
             */
            ready() {
                super.ready();
                Polymer.RenderStatus.afterNextRender(this, function() {
                });
            }

            /**
             * Muestra el formulario para agregar un servicio. 
             */
            _addServicio() {
                servicioFormInstance.open();
            }

            /** Borra el servicio. */
            _deleteServicio(e) {
                this.splice('servicios', e.model.index, 1);
            }

            /** Activa formulario para editar sesion. */
            _editSesion(e) {
                this.editingSesion = e.model.item;

                let sesion = e.model.item.node;
                this.sesionValue = {
                    fecha: moment.utc(sesion.fecha).format('YYYY-MM-DD'),
                    hora: moment.utc(sesion.fecha).format('HH:mm'),
                    estado: sesion.estado,
                    medico: sesion.medico.id,
                    autorizacion: sesion.autorizacion,
                    fechaAutorizacion: (sesion.fechaAutorizacion) ? moment.utc(sesion.fechaAutorizacion).format('YYYY-MM-DD') : null,
                    sucursal: sesion.sucursal.id
                };

                this.$.grid.clearCache();
            }

            /** Cancela la edición de la sesión. */
            _cancelEditSesion() {
                this.editingSesion = null;
                this.sesionValue = null;
                this.$.grid.clearCache();
            }

            /** Guarda la sesión editada. */
            _saveEditedSesion(e) {
                let sesion = e.model.item.node;
                sesion.fecha = `${this.sesionValue.fecha} ${this.sesionValue.hora}`;
                sesion.estado = this.sesionValue.estado;
                sesion.estadoDisplay = this.sesionValue.estadoItem.label;
                sesion.autorizacion = this.sesionValue.autorizacion;
                sesion.fechaAutorizacion = (this.sesionValue.fechaAutorizacion) ? this.sesionValue.fechaAutorizacion : null;
                sesion.medico = {
                    id: this.sesionValue.medicoItem.node.id,
                    nombreCompleto: this.sesionValue.medicoItem.node.nombreCompleto
                };
                sesion.sucursal = {
                    id: this.sesionValue.sucursalItem.node.id,
                    nombre: this.sesionValue.sucursalItem.node.nombre
                }
                sesion.invalid = false;

                this.editingSesion = null;
                this.sesionValue = null;
                this.$.grid.clearCache();
            }

            /**
             * Listener que indica que se debe crear un servicio.
             */
            _addServicioListener(e) {
                let data = e.detail.data;
                let servicioRealizar = {
                    node: {
                        numeroSesiones: data.numeroSesiones,
                        sesionesCumplidas: 0,
                        valor: data.valor,
                        coopago: data.coopago,
                        servicio: {
                            id: data.servicioItem.node.id,
                            nombre: data.servicioItem.node.nombre
                        },
                        sesiones: {
                            edges: this._createSesiones(data)
                        }
                    }
                }

                this.push('servicios', servicioRealizar);
                this.selectServicio(servicioRealizar);
            }

            /**
             * Crea las sesiones a partir número de sesiones ingresadas. @todo traer estados del servidor
             * 
             * @param {Param} data Datos del formulario con los cuales se crean las sesiones.
             */
            _createSesiones(data) {
                let sesiones = [];
                let fechaActual = `${data.fecha} ${data.hora}`;
                let estado =  (data.cita) ? data.estado : 'CU';
                let estadoDisplay =  (data.cita) ? data.estadoDisplay : 'Cumplida';
                for (let i = 0; i < data.numeroSesiones; i++) {
                    let sesion = {
                        node: {
                            fecha: fechaActual,
                            estado: (i == 0) ? estado : 'NC',
                            estadoDisplay: (i == 0) ? estadoDisplay : 'No comfirmada',
                            autorizacion: data.autorizacion,
                            fechaAutorizacion: data.fechaAutorizacion,
                            cita: (i == 0 && data.cita) ? data.cita : null,
                            medico: {
                                id: data.medicoItem.node.id,
                                nombreCompleto: data.medicoItem.node.nombreCompleto
                            },
                            sucursal: {
                                id: data.sucursalItem.node.id,
                                nombre: data.sucursalItem.node.nombre
                            }
                        }
                    };
                    /** @todo Modificar el estado, autorizaciones segun empresa  */
                    sesiones.push(sesion);
                    fechaActual = this._getNextDate(fechaActual);
                }

                return sesiones;
            }

            /**
             * Retorna la fecha de la siguiente sesión de acuerdo a la fecha ingresada.
             * 
             * @param {string} date Fecha a partir de la cual se calcula la siguiente fecha.
             * @return {string} Posible fecha de la siguiente sesión.
             */
            _getNextDate(date) {
                let next = moment(date).add(1, 'days');
                if (next.day() == 0) {
                    next = next.add(1, 'days');
                }

                return next.format('YYYY-MM-DD HH:mm');
            }

            /**
            * Normaliza las variables en un objecto para ser usadas en graphql query
            * 
            * @param {string} institucion institucion escogida
            * @return {{institucion: string}} Objeto para ser usado en query
            */
            _queryVariables(institucion) {
                return { institucion };
            }

            /**
             * Formatea la fecha de la sesion 
             * 
             * @param {string} date Fecha en que se realiza la sesión
             * @return {string} La fecha en formato Martes, 12/02/2017
             */
             _formatFecha(date) {
                return moment(date).format("dddd, DD/MM/YYYY");
            }

            /**
             * Formatea la hora de la sesion
             * 
             * @param {string} date Fecha en que se realiza la sesión
             * @return {string} La hora en formato 02:30 PM
             */
             _formatHora(date) {
                return moment.utc(date).format("hh:mm a");
            }

            /**
             * Formatea el valor ingresado. 
             * 
             * @param {number} value Valor a formatear
             * @return {string} Valor formateado
             */
             _formatCurrency(value) {
                 if (value != undefined) return value.toLocaleString('es', {style: 'currency', currency: 'COP'});
                 return value;
            }

            /**
             * Calcula el número de sesiones que el paciente tiene pendientes para el servicio seleccionado.
             * 
             * @param {number} numSesiones Número de sesiones
             * @param {number} sesionesCumplidas Número de sesiones cumplidas
             *
             * @return {number} Número de sesiones pendientes por cumplir
             */
             _calcularSesionesPendientes(numSesiones, sesionesCumplidas) {
                return numSesiones - sesionesCumplidas || 0;
            }

            /**
             * Calcula el valor total de las sesiones del servicio.
             * 
             * @param {number} numSesiones Número de sesiones
             * @param {number} valorSesion Valor por sesión
             *
             * @return {number} Valor total de las sesiones.
             */
             _calcularTotal(numSesiones, valorSesion) {
                return this._formatCurrency(numSesiones*valorSesion || 0);
            }

            /**
             * Indica si la sesión en la fila actual se esta editando.
             * 
             * @param {object} editingSesion Sesión que se esta editando.
             * @param {object} item Sesion de la fila
             *
             * @return {boolean}
             */
             _isEditingSesion(editingSesion, item) {
                return editingSesion == item;
            }

            /**
             * Valida que por lo menos haya un servicio.
             * 
             * @return {boolean} True si el los servicios estan validos, false si no.
             */
             validate() {
                return this.servicios.length > 0;
            }

            /**
             * Selecciona un servicio de las lista de servicios.
             * 
             * @param {object} servicio Servicio a seleccionar.
             */
             selectServicio(servicio) {
                this.$.serviciosList.selectItem(servicio);
            }

            /**
             * Selecciona un servicio de las lista de servicios según su indice.
             * 
             * @param {number} index Indice del servicio a seleccionar.
             */
             selectServicioByIndex(index) {
                this.$.serviciosList.selectIndex(index);
            }

            /**
            * Muestra los errores obtenidos de la respuesta del servidor.
            *
            * @param {object} errors Respuesta del servidor.
            */
            setErrors(errors) {
                errors.servicios_realizar.forEach((servicio, iServicio) => {
                    let invalid = false;
                    if ('sesiones' in servicio) {
                        servicio.sesiones.forEach((sesion, iSesion) => {
                            if (Object.keys(sesion).length > 0) {
                                this.servicios[iServicio].node.sesiones.edges[iSesion].node.invalid = true;
                                invalid = true;
                            }
                            else {
                                this.servicios[iServicio].node.sesiones.edges[iSesion].node.invalid = false;
                            }
                        });
                    }

                    this.set(`servicios.${iServicio}.node.invalid`, invalid);
                });

                this.$.grid.clearCache();
            }
        }

        window.customElements.define(ServiciosOrden.is, ServiciosOrden);
    }());
</script>
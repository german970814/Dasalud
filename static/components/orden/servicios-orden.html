<link rel="import" href="/static/bower_components/polymer/polymer-element.html">

<link rel="import" href="/static/bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="/static/bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="/static/bower_components/paper-button/paper-button.html">
<link rel="import" href="/static/bower_components/iron-form/iron-form.html">
<link rel="import" href="/static/bower_components/paper-input/paper-input.html">
<link rel="import" href="/static/bower_components/apollo-client/graphql-query.html">
<link rel="import" href="/static/bower_components/vaadin-material-theme/vaadin-date-picker.html">
<link rel="import" href="/static/bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="/static/bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="/static/bower_components/show-json/show-json.html">

<link rel="import" href="/static/bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="/static/bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="/static/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/static/bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="/static/bower_components/iron-list/iron-list.html">
<link rel="import" href="/static/bower_components/paper-item/paper-item.html">
<link rel="import" href="/static/my-icons.html">


<dom-module id="servicio-form">
    <template>
        <style>
            :host {
                display: block
            }

            paper-dialog {
                width: 60%;
            }

            .row {
                display: flex;
                align-items: flex-end;
            }
            
            .row > * {
                flex: 1;
                margin-right: 10px;
            }

            .row:last-child paper-input:first-child {
                flex: 0 1 auto;
            }
        </style>

        <graphql-query id="query" variables="[[_queryVariables(institucion, plan)]]" result="{{queryResult}}">
            query servicioFormData($plan: ID, $institucion: ID){
                servicios(planes: [$plan]) {
                    edges {
                        node {
                            id
                            nombre
                            tarifas(plan: $plan) {
                                edges {
                                    node {
                                        valor
                                    }
                                }
                            }
                        }
                    }
                }
                medicos(instituciones: [$institucion]) {
                    edges {
                        node {
                            id
                            nombreCompleto
                        }
                    }
                }
                sucursales {
                    edges {
                        node {
                            id
                            nombre
                        }
                    }
                }
            }
        </graphql-query>

        <paper-dialog modal id="dialog">
            <h2>Nuevo Servicio</h2>

            <paper-dialog-scrollable>
                <iron-form id="form">
                    <form>
                        <div class="row">
                            <vaadin-combo-box label="Sucursal*" required items="[[queryResult.sucursales.edges]]"  
                                auto-validate value="[[value.sucursal]]" selected-item="{{value.sucursalItem}}"
                                item-label-path="node.nombre" item-value-path="node.id">
                            </vaadin-combo-box>
                            <vaadin-combo-box label="Medico*" required items="[[queryResult.medicos.edges]]" 
                                auto-validate value="[[value.medico]]" selected-item="{{value.medicoItem}}"
                                item-label-path="node.nombreCompleto" item-value-path="node.id">
                            </vaadin-combo-box>
                        </div>
                        <div class="row">
                            <vaadin-combo-box label="Servicio*" required items="[[queryResult.servicios.edges]]" 
                                auto-validate value="[[value.servicio]]" selected-item="{{value.servicioItem}}"
                                item-label-path="node.nombre" item-value-path="node.id">
                            </vaadin-combo-box>
                        </div>
                        <div class="row">
                            <vaadin-date-picker label="Fecha*" required auto-validate value="{{value.fecha}}">
                            </vaadin-date-picker>
                            <paper-input type="time" label="Hora*" required value="{{value.hora}}"></paper-input>
                        </div>
                        <div class="row">
                            <paper-input label="Autorización" value="{{value.autorizacion}}"></paper-input>
                            <vaadin-date-picker name="fecha_autorizacion" label="Fecha autorización" 
                                value="{{value.fechaAutorizacion}}">
                            </vaadin-date-picker>
                        </div>
                        <div class="row">
                            <paper-input label="# de sesiones*" type="number" required 
                                auto-validate min="1" value="{{value.numeroSesiones}}">
                            </paper-input>
                            <paper-input label="Valor de la sesión*" type="number" required 
                                auto-validate min="0" value="{{value.valor}}">
                            </paper-input>
                            <paper-input label="Coopago/Moderadora" type="number" auto-validate min="0" 
                                value="{{value.coopago}}" required>
                            </paper-input>
                        </div>                
                    </form>
                </iron-form>
                <show-json json="[[value]]"></show-json>
            </paper-dialog-scrollable>

            <div class="buttons">
                <paper-button dialog-dismiss>Cancelar</paper-button>
                <paper-button on-tap="add">Agregar</paper-button>
            </div>
        </paper-dialog>

    </template>
</dom-module>

<dom-module id="servicios-orden">
    <template>
        <style>
            :host {
                display: block;
                border: 1px solid #e8e8e8;
            }

            .grid {
                display: grid;
                grid-template-columns: 20% 1fr;
                grid-template-rows: 20% 1fr;
                grid-template-areas: 
                "servicios servicio-info"
                "servicios sesiones";
                box-sizing: border-box;
                height: 540px;
            }

            .servicios {
                grid-area: servicios;
                display: flex;
                flex-direction: column;
                border-right: 1px solid #e8e8e8;
                /* padding: 5px; */
            }

            .servicios app-toolbar {
                border-bottom: 1px solid #e8e8e8;
            }

            .servicios iron-list {
                flex: 1;
            }

            .servicios iron-list paper-item {
                border-bottom: 1px solid #e8e8e8;
            }

            .servicios iron-list paper-item[selected] {
                background-color: #e4e2e2;
                font-weight: bold;
                color: #3e3c3c;
            }

            .servicio-info {
                grid-area: servicio-info;
                display: grid;
                grid-template: 1fr 1fr / 1fr 1fr 1fr;
                border-bottom: 1px solid #e8e8e8;
                padding: 5px;
            }
            .sesiones {
                grid-area: sesiones;
                padding: 5px;
            }
        </style>
        
        <div class="grid">
            <div class="servicios">
                <app-toolbar>
                    <paper-icon-button icon="my-icons:add" on-tap="_addServicio"></paper-icon-button>
                </app-toolbar>
                <iron-list id="serviciosList" items="[[servicios]]" selection-enabled selected-item="{{selectedServicio}}">
                    <template>
                        <paper-item selected$="[[selected]]">[[item.node.servicio.nombre]]</paper-item>
                    </template>
                </iron-list>
            </div>
            <div class="servicio-info">
                <p><b>Numero de sesiones:</b> [[selectedServicio.node.numeroSesiones]]</p>
                <p><b>Cumplidas:</b> 5</p>
                <p><b>Pendientes:</b> 5</p>
                <p><b>Valor de la sesión:</b> $[[selectedServicio.node.valor]]</p>
                <p><b>Coopago/Cuota Moderadora:</b> $[[selectedServicio.node.coopago]]</p>
                <p><b>Fecha Inicio:</b> 10/10/2017</p>
            </div>
            <div class="sesiones">
                <vaadin-grid id="grid" items="[[selectedServicio.node.sesiones.edges]]">
                    <vaadin-grid-column>
                        <template class="header">Fecha</template>
                        <template>[[_formatFecha(item.node.fecha)]]</template>
                    </vaadin-grid-column>
                    <vaadin-grid-column>
                        <template class="header">Hora</template>
                        <template>[[_formatHora(item.node.fecha)]]</template>
                    </vaadin-grid-column>
                    <vaadin-grid-column>
                        <template class="header">Estado</template>
                        <template>[[item.node.estado]]</template>
                    </vaadin-grid-column>
                    <vaadin-grid-column>
                        <template class="header">Medico</template>
                        <template>[[item.node.medico.nombreCompleto]]</template>
                    </vaadin-grid-column>
                    <vaadin-grid-column>
                        <template class="header">Autorización</template>
                        <template>[[item.node.autorizacion]]</template>
                    </vaadin-grid-column>
                    <vaadin-grid-column>
                        <template class="header">Fecha Autorización</template>
                        <template>[[item.node.fechaAutorizacion]]</template>
                    </vaadin-grid-column>
                    <vaadin-grid-column>
                        <template class="header">Sucursal</template>
                        <template>[[item.node.sucursal.nombre]]</template>
                    </vaadin-grid-column>
                </vaadin-grid>
            </div>
        </div>
    </template>

</dom-module>

<script>
    (function() {

        let servicioFormInstance = null;

        /**
         * `servicio-form` Formulario para agregar un servicio a una orden.
         *
         * @customElement
         * @polymer
         * @extends {Polymer.Element}
         */
         class ServicioForm extends Polymer.Element {
            /**
             * String providing the tag name to register the element under.
             */
            static get is() {
                return 'servicio-form';
            }

            /**
            * Emitido cuando el formulario es valido y se presiona el boton Agregar.
            *
            * @param {Param} data Datos del servicio a agregar.
            * @event add-servicio
            */

            /**
             * Object describing property-related metadata used by Polymer features
             */
            static get properties() {
                return {
                    /**
                     * Filtra los medicos permitidos a escoger.
                     */
                    institucion: {
                        type: String,
                        value: ''
                    },

                    /**
                     * Filtra los servicios permitidos a escoger.
                     */
                    plan: {
                        type: String,
                        value: ''
                    },

                    /**
                     * Datos del formulario.
                     *
                     * @type {{sucursal: string, sucursalItem: Object, medico: string, medicoItem: Object, servicio: string, servicioItem: Object, fecha: string, hora: string, autorizacion: string, fechaAutorizacion: string, numeroSesiones: number, valor: number, coopago: number}}
                     */
                    value: {
                        type: Object,
                        value: () => { return {}; }
                    }
                };
            }

            /**
              * Array of strings describing multi-property observer methods and their
              * dependant properties
              */
            static get observers() {
                return [
                    '_cleanNumberValues(value.numeroSesiones, value.valor, value.coopago)',
                    '_setFieldValorServicio(value.servicioItem)'
                ];
            }

            /**
             * Instance of the element is created/upgraded. Use: initializing state,
             * set up event listeners, create shadow dom.
             * @constructor
             */
            constructor() {
                super();
                if (!servicioFormInstance) servicioFormInstance = this;
            }

            /**
            * Normaliza las variables en un objecto para ser usadas en graphql query
            * 
            * @param {string} institucion institucion escogida
            * @param {string} plan plan escogido
            * @return {{institucion: string, plan: string}} Objeto para ser usado en query
            */
            _queryVariables(institucion, plan) {
                return { institucion, plan };
            }

            /**
            * Normaliza a null los valores numericos cuando estan vacios.
            * 
            * @param {number} numeroSesiones Valor del input numeroSesiones
            * @param {number} valor Valor del input valor 
            * @param {number} coopago Valor del input coopago 
            */
            _cleanNumberValues(numeroSesiones, valor, coopago) {
                if (numeroSesiones == '') {
                    this.set('value.numeroSesiones', null);
                }

                if (valor == '') {
                    this.set('value.valor', null);
                }

                if (coopago == '') {
                    this.set('value.coopago', null);
                }
            }

            /**
            * Setea el valor por sesion de acuerdo al servicio escogido.
            * 
            * @param {object} servicio Servicio escogido
            */
            _setFieldValorServicio(servicio) {
                if (servicio) {
                    this.set('value.valor', servicio.node.tarifas.edges[0].node.valor);
                }
            }

            /** Muestra el formulario. */
            open() {
                this.$.dialog.open();
            }

            /** Oculta el formulario. */
            close() {
                this.$.dialog.close();
            }

            /** Limpia el formulario. */
            clean() {
                this.value = {};
            }

            /**
            * Valida el formulario
            * 
            * @returns {boolean} True si el formulario es valido, false si es invalido.
            */
            validate() {
                return this.$.form.validate();
            }

            /**
            * Verifica que el formulario sea valido y notifica si se debe agregar un nuevo servicio.
            */
            add() {
                if (this.validate()) {
                    this.close();
                    this.dispatchEvent(new CustomEvent('add-servicio', {
                        detail: { data: this.value }
                    }));
                    this.clean();
                }
            }            

        }

        window.customElements.define(ServicioForm.is, ServicioForm);

        /**
         * `servicios-orden` Muestra los servicios de una orden.
         *
         * @customElement
         * @polymer
         * @extends {Polymer.Element}
         */
         class ServiciosOrden extends Polymer.Element {
            /**
             * String providing the tag name to register the element under.
             */
            static get is() {
                return 'servicios-orden';
            }

            /**
             * Object describing property-related metadata used by Polymer features
             */
            static get properties() {
                return {
                    /**
                     * Servicios a realizar en la orden.
                     */
                    servicios: {
                        type: Array,
                        value: () => { return []; }
                    },

                    /**
                     * Servicio seleccionado de la lista de servicios.
                     */
                    selectedServicio: {
                        type: Object,
                        value: () => { return {}; }
                    }
                };
            }

            /**
             * Instance of the element is created/upgraded. Use: initializing state,
             * set up event listeners, create shadow dom.
             * @constructor
             */
            constructor() {
                super();
                this._boundAddServicioListener = this._addServicioListener.bind(this);
            }

            /**
              * Called every time the element is inserted into the DOM. Useful for 
              * running setup code, such as fetching resources or rendering.
              * Generally, you should try to delay work until this time.
              */
            connectedCallback() {
                super.connectedCallback();
                servicioFormInstance.addEventListener('add-servicio', this._boundAddServicioListener);
            }

            /**
              * Called every time the element is removed from the DOM. Useful for 
              * running clean up code (removing event listeners, etc.).
              */
            disconnectedCallback() {
                super.disconnectedCallback();
                servicioFormInstance.removeEventListener('add-servicio', this._boundAddServicioListener);
            }

            /**
             * Use for one-time configuration of your component after local DOM is initialized. 
             */
            ready() {
                super.ready();

                Polymer.RenderStatus.afterNextRender(this, function() {
                    
                });
            }

            /**
             * Muestra el formulario para agregar un servicio. 
             */
            _addServicio() {
                servicioFormInstance.open();
            }

            /**
             * Listener que indica que se debe crear un servicio.
             */
            _addServicioListener(e) {
                let data = e.detail.data;
                let servicioRealizar = {
                    node: {
                        numeroSesiones: data.numeroSesiones,
                        valor: data.valor,
                        coopago: data.coopago,
                        servicio: {
                            id: data.servicioItem.node.id,
                            nombre: data.servicioItem.node.nombre
                        },
                        sesiones: {
                            edges: this._createSesiones(data)
                        }
                    }
                }

                this.push('servicios', servicioRealizar);
                this.$.serviciosList.selectItem(servicioRealizar);
            }

            /**
             * Crea las sesiones a partir número de sesiones ingresadas.
             * 
             * @param {Param} data Datos del formulario con los cuales se crean las sesiones.
             */
            _createSesiones(data) {
                let sesiones = [];
                let fechaActual = `${data.fecha} ${data.hora}`;
                console.log(data);
                for (let i = 0; i < data.numeroSesiones; i++) {
                    let sesion = {
                        node: {
                            fecha: fechaActual,
                            estado: 'No cumplida',
                            autorizacion: data.autorizacion,
                            fechaAutorizacion: data.fechaAutorizacion,
                            medico: {
                                id: data.medicoItem.node.id,
                                nombreCompleto: data.medicoItem.node.nombreCompleto
                            },
                            sucursal: {
                                id: data.sucursalItem.node.id,
                                nombre: data.sucursalItem.node.nombre
                            }
                        }
                    };
                    /** @todo Modificar el estado, autorizaciones segun empresa  */
                    sesiones.push(sesion);
                    fechaActual = this._getNextDate(fechaActual);
                }

                return sesiones;
            }

            /**
             * Retorna la fecha de la siguiente sesión de acuerdo a la fecha ingresada.
             * 
             * @param {string} date Fecha a partir de la cual se calcula la siguiente fecha.
             * @return {string} Posible fecha de la siguiente sesión.
             */
            _getNextDate(date) {
                let next = moment(date).add(1, 'days');
                if (next.day() == 6) {
                    next = next.add(2, 'days');
                }

                return next.format('YYYY-MM-DD HH:mm');
            }

            /**
             * Formatea la fecha de la sesion 
             * 
             * @param {string} date Fecha en que se realiza la sesión
             * @return {string} La fecha en formato Martes, 12/02/2017
             */
             _formatFecha(date) {
                return moment(date).format("dddd, DD/MM/YYYY");
            }

            /**
             * Formatea la hora de la sesion
             * 
             * @param {string} date Fecha en que se realiza la sesión
             * @return {string} La hora en formato 02:30 PM
             */
             _formatHora(date) {
                return moment(date).format("hh:mm a");
            }

            /**
             * Valida que por lo menos haya un servicio.
             * 
             * @return {boolean} True si el los servicios estan validos, false si no.
             */
             validate() {
                return this.servicios.length > 0;
            }            
        }

        window.customElements.define(ServiciosOrden.is, ServiciosOrden);
    }());
</script>
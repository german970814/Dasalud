<link rel="import" href="/static/bower_components/polymer/polymer-element.html">
<link rel="import" href="/static/bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="/static/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/static/bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="/static/bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="/static/bower_components/paper-input/paper-input.html">
<link rel="import" href="/static/bower_components/paper-button/paper-button.html">
<link rel="import" href="/static/bower_components/iron-form/iron-form.html">
<link rel="import" href="/static/bower_components/paper-time-input/paper-time-input.html">
<link rel="import" href="/static/bower_components/apollo-client/graphql-query.html">
<link rel="import" href="/static/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/static/components/vaadin-grid-material-styles.html">
<link rel="import" href="/static/components/ig-iron-ajax.html">
<link rel="import" href="detalle-servicio.html">
<link rel="import" href="agenda-citas.html">
<link rel="import" href="servicio-form.html">


<dom-module id="servicios-orden">
    <template strip-whitespace>
        <style include="vaadin-grid-material-styles">
            :host {
                display: block
            }
            
            .row {
                display: flex;
                align-items: flex-end;
            }

            .row > paper-time-input {
                flex: 0;
            }
            .row > * {
                flex: 1;
                margin-right: 5px;
            }

            .detail {
                padding: 10px;
            }
        </style>

        <agenda-citas id="citas" documento="[[paciente.numero_documento]]" on-cita-selected="_citaSelected"></agenda-citas>

        <servicio-form id="form" cita="[[cita]]"></servicio-form>

        <paper-button on-tap="_add">Agregar</paper-button>
        <paper-button on-tap="_showCitas">Citas no asociadas</paper-button>
        <br><br>
        <vaadin-grid id="grid" items="[[servicios]]">

            <template class="row-details">
                <div class="detail">
                    <detalle-servicio sesiones="[[item.sesiones]]" on-open-calendar="_openCalendar"></detalle-servicio>                    
                </div>
            </template>

            <vaadin-grid-column flex-grow="0">
                <template class="header"></template>
                <template>
                    <div class="cell first">
                        <input id="checkBox" type="checkbox" hidden checked="{{expanded::change}}">
                        <paper-icon-button icon="my-icons:keyboard-arrow-down" on-tap="_showDetail"></paper-icon-button>
                    </div>
                </template>
            </vaadin-grid-column>
            <vaadin-grid-column>
                <template class="header">
                    <div class="cell">Medico</div>
                </template>
                <template>
                    <div class="cell">[[item.medicoItem.node.nombreCompleto]]</div>
                </template>
            </vaadin-grid-column>
            <vaadin-grid-column>
                <template class="header">
                    <div class="cell">Servicio</div>
                </template>
                <template>
                    <div class="cell">[[item.servicioItem.node.nombre]]</div>
                </template>
            </vaadin-grid-column>
            <vaadin-grid-column>
                <template class="header">
                    <div class="cell"># de sesiones</div>
                </template>
                <template>
                    <div class="cell numeric">[[item.numero_sesiones]]</div>
                </template>
            </vaadin-grid-column>
            <vaadin-grid-column>
                <template class="header">
                    <div class="cell">Valor sesi√≥n</div>
                </template>
                <template>
                    <div class="cell numeric">[[item.valor]]</div>
                </template>
            </vaadin-grid-column>
            <vaadin-grid-column>
                <template class="header">
                    <div class="cell">Coopago/Moderadora</div>
                </template>
                <template>
                    <div class="cell numeric">[[item.coopago]]</div>
                </template>
            </vaadin-grid-column>
            <vaadin-grid-column flex-grow="0">
                <template class="header">
                    <div class="cell last"></div>
                </template>
                <template>
                    <div class="cell last">
                        <paper-icon-button icon="my-icons:delete" on-tap="_delete"></paper-icon-button>
                    </div>
                </template>
            </vaadin-grid-column>            
        </vaadin-grid>
        <p>TOTAL: <span id="total"></span></p>
    </template>

    <script>
        class ServiciosOrden extends Polymer.Element {

            static get is() { return 'servicios-orden'; }

            static get properties() {
                return {
                    paciente: Object,
                    cita: Object,
                    institucion: {
                        type: String,
                        value: "SW5zdGl0dWNpb246MQ=="
                    },
                    plan: {
                        type: String,
                        value: "UGxhbjoy"
                    },
                    servicios: {
                        type: Array,
                        value() {
                            return [];
                        }
                    },
                    total: Number
                };
            }

            ready() {
                super.ready();
                Polymer.RenderStatus.afterNextRender(this, function() {
                    
                });
            }

            _showCitas() {
                this.$.citas.open();
            }

            _citaSelected(e) {
                this.$.form.cita = e.detail;
            }

            _showDetail(e) {
                e.model.expanded = !e.model.expanded;
            }            

            _add() {
                if (this.$.form.validate()){ 
                    let data = this.$.form.value;
                    let actual = JSON.parse(JSON.stringify(data));
                    actual.sesiones = this._createSessions(actual.numero_sesiones, data);
                    this.servicios.unshift(actual);
                    this.$.grid.clearCache();
                    this.$.form.reset();
                    this.total = this.calcularTotal();
                }
            }

            _delete(e) {
                let index = this.servicios.indexOf(e.model.item);
                this.servicios.splice(index, 1);
                this.total = this.calcularTotal();
                this.$.grid.clearCache();
            }

            _createSessions(number, info) {
                let sessions = [];
                let lastDate = info.fecha;
                for (var i = 0; i < number; i++) {
                    let sesion = {};
                    sesion.hora = info.hora;               
                    sesion.estado = info.estado;               
                    sesion.autorizacion = info.autorizacion;               
                    sesion.fecha_autorizacion = info.fecha_autorizacion;               
                    sesion.sucursal = info.sucursalItem;
                    if('cita' in info) {
                        if(i == 0) {
                            sesion.cita = info.cita;
                            sesion.estado = info.estado;
                        }
                    }

                    if(i > 0) {
                        lastDate = this._getNextDate(lastDate);
                    }
                    sesion.fecha = lastDate;
                    sessions.push(sesion);
                }

                return sessions;
            }

            _getNextDate(date) {
                let next = moment(date).add(1, 'days');
                if (next.day() == 6) {
                    next = next.add(2, 'days');
                }

                return next.format('YYYY-MM-DD');
            }

            _openCalendar(e) {
                console.log(e);
                this.dispatchEvent(new CustomEvent('open-calendar', {detail: {servicio: e.model, sesion: e.detail}}));
            }

            updateCita(servicio, sesion, cita) {
                this.servicios[servicio].sesiones[sesion].fecha = cita.fecha;
                this.servicios[servicio].sesiones[sesion].hora = cita.hora;
                this.$.grid.clearCache();
            }

            calcularTotal() {
                let total = 0;
                this.servicios.forEach((servicio) => {
                    total = total + (servicio.valor * servicio.numero_sesiones);
                });
                this.$.total.innerHtml = total;
                return total;
            }

            serialize() {
                let servicios = [];
                this.servicios.forEach((element) => {
                    let sesiones = [];
                    element.sesiones.forEach((sesionD) => {
                        let sesion = {
                            medico: element.medico,
                            sucursal: element.sucursal,
                            fecha: sesionD.fecha + ' ' + sesionD.hora,
                            autorizacion: sesionD.autorizacion,
                            fecha_autorizacion: sesionD.fecha_autorizacion
                        };

                        if('cita' in sesionD) sesion.cita = sesionD.cita;
                        if('estado' in sesionD) sesion.estado = sesionD.estado;

                        sesiones.push(JSON.parse(JSON.stringify(sesion)));
                    });

                    let servicio = {
                        servicio: element.servicio,
                        valor: element.valor,
                        coopago: element.coopago,
                        numero_sesiones: element.numero_sesiones,
                        sesiones: sesiones
                    };

                    servicios.push(JSON.parse(JSON.stringify(servicio)));          
                });

                return servicios;
            }
        }

        window.customElements.define(ServiciosOrden.is, ServiciosOrden);
    </script>
</dom-module>
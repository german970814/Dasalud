<link rel="import" href="/static/bower_components/polymer/polymer-element.html">
<link rel="import" href="/static/bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="/static/bower_components/apollo-client/graphql-query.html">
<link rel="import" href="/static/components/resource-scheduler.html">
<link rel="import" href="/static/bower_components/show-json/show-json.html">

<dom-module id="agenda-multiple">
    <template>
        <style>
            :host {
                display: block
            }

            * {
                box-sizing: border-box;
            }            

            @media (min-width: 40em) {
                .row {
                display: flex;
                }

                .row > * {
                    flex: 1;
                    margin: auto 10px; 
                }
            }
        </style>

        <graphql-query result="{{filtrosResult}}">
            query agendaMultipleFiltrosQuery{
                sucursales {
                    edges {
                        node { id, nombre }
                    }
                }
                agendas {
                    edges {
                        node { id, nombre, duracion }
                    }
                }
            }
        </graphql-query>

        <graphql-query id="citasQuery" hold>
            query agendaMultipleCitasQuery($agenda: ID!, $sucursal: ID!){
                medicos(agenda: $agenda, sucursal: $sucursal) {
                    edges {
                        node { id, title }
                    }
                }
                horariosAtencion(agenda: $agenda, sucursal: $sucursal) {
                    edges {
                        node { id, start, end, resourceId }
                    }
                }
                citas(agenda: $agenda, sucursal: $sucursal) {
                    edges {
                        node { 
                            id, start, end, title, resourceId
                        }
                    }
                }
            }
        </graphql-query>

        <div class="row">
            <vaadin-combo-box label="Agenda*" auto-validate required items="[[filtrosResult.agendas.edges]]"
                item-value-path="node.id" item-label-path="node.nombre" selected-item="{{filtros.agendaItem}}">
            </vaadin-combo-box>
            <vaadin-combo-box label="Sucursal*" auto-validate required items="[[filtrosResult.sucursales.edges]]"
                item-value-path="node.id" item-label-path="node.nombre" selected-item="{{filtros.sucursalItem}}">
            </vaadin-combo-box>
        </div>
        <!-- <show-json json="[[filtros]]"></show-json> -->
        <br>
        <resource-scheduler header='{"left": "prev,next, today", "center": "title", "right": "timelineDay,timelineWeek"}'
            default-view="timelineDay" slot-duration="[[filtros.agendaItem.node.duracion]]" id="calendar"
            on-event-click="_citaClicked" selectable on-select-overlap="_espacioDisponibleClicked">
        </resource-scheduler>

    </template>

    <script>
        /**
         * `agenda-multiple` Muestra el calendario en una vista con multiples doctores.
         *
         * @customElement
         * @polymer
         * @extends {Polymer.Element}
         */
        class AgendaMultiple extends Polymer.Element {
            /**
             * String providing the tag name to register the element under.
             */
            static get is() {
                return 'agenda-multiple';
            }

            /**
             * Object describing property-related metadata used by Polymer features
             */
            static get properties() {
                return {
                    /**
                     * Filtros escogidos por el usuario. Se usan para definir los datos mostrados en el calendario.
                     * 
                     * @type {{agendaItem: object, sucursalItem: object}}
                     */
                    filtros: {
                        type: Object,
                        value: () => { return {}; }
                    }
                };
            }

            /**
              * Array of strings describing multi-property observer methods and their
              * dependant properties
              */
            static get observers() {
                return [
                    'getCalendarInfo(filtros.agendaItem.node.id, filtros.sucursalItem.node.id)'
                ];
            }

            /**
             * Instance of the element is created/upgraded. Use: initializing state,
             * set up event listeners, create shadow dom.
             * @constructor
             */
            constructor() {
                super();
            }

            /**
             * Fired cuando una `cita` en el calendario es presionada.
             *
             * @event cita-click
             * @param {object} cita Cita presionada.
             */

            /**
             * Fired cuando un espacio disponible para cita es presionada en el calendario.
             *
             * @event disponible-click
             * @param {object} event Espacio disponible presionado.
             */

            /**
             * Use for one-time configuration of your component after local DOM is initialized. 
             */
            ready() {
                super.ready();

                Polymer.RenderStatus.afterNextRender(this, function() {
                    
                });
            }

            /** 
             * Convierte la respuesta del query de citas para poder ser usado por fullCalendar
             * 
             * @param {Array<object>} array
             * @return {Array<object>} 
             */
            _normalizeConnections(array) {
                let newArray = [];
                array.forEach(element => {
                    newArray.push(element.node);
                });

                return newArray;
            }

            /** Bubbles event click on calendar */
             _citaClicked(e) {
                let cita = e.detail.calEvent;
                this.dispatchEvent(new CustomEvent('cita-click', { detail: { cita } }));
            }

            /** Fires un evento que indica que se presiono un espacio disponible para crear un cita */
            _espacioDisponibleClicked(e) {
                let event = e.detail.event;
                if (event.source.rendering == 'background') {
                    this.dispatchEvent(new CustomEvent('disponible-click', { detail: { event } }));
                }
            }

            /** 
             * Obtiene las citas y los medicos para el calendario.
             * 
             * @param {string} agenda Valor escogido de la agenda.
             * @param {string} sucursal Valor escogido de la sucursal.
             */
            getCalendarInfo(agenda, sucursal) {
                if (agenda && sucursal) {
                    this.$.citasQuery.variables = {agenda, sucursal};
                    this.$.citasQuery.execute().result().then(result => {
                        this.$.calendar.resources = this._normalizeConnections(result.data.medicos.edges);
                        this.$.calendar.backgroundEvents = this._normalizeConnections(result.data.horariosAtencion.edges);
                        this.$.calendar.events = this._normalizeConnections(result.data.citas.edges);
                    });
                }
                else {
                    this.$.calendar.resources = [];
                    this.$.calendar.backgroundEvents = [];
                    this.$.calendar.events = [];
                }
            }

        }

        window.customElements.define(AgendaMultiple.is, AgendaMultiple);
    </script>
</dom-module>
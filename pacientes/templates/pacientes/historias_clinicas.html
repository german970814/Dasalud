{% extends "base.html" %}
{% load i18n static %}

{% block imports %}
    <link rel="import" href="/static/bower_components/vaadin-combo-box/vaadin-combo-box.html">
    <link rel="import" href="/static/bower_components/iron-ajax/iron-ajax.html">
    <link rel="import" href="/static/components/paciente-info.html">
    <link rel="import" href="/static/components/historia-clinica/historia-clinica.html">
{% endblock imports %}

{% block content %}
    <paciente-info paciente='{{ paciente }}' full-width></paciente-info>
    <br>

    <iron-ajax id="request" url="{% url "pacientes:historias" pk %}" method="POST" handle-as="json"
                content-type="application/json">
    </iron-ajax>
    <historia-clinica id="historia" historia='{{ historia }}'></historia-clinica>
{% endblock content %}

{% block js %}
    <script src="{% static 'js/utils.js' %}"></script>
    <script>
        let historiaNode = document.getElementById('historia');
        historiaNode.addEventListener('save-historia', function(e) {
            e.stopPropagation();

            let request = document.getElementById('request');
            request.headers = {'X-CSRFToken': getCsrfToken()}
            // TODO modificar el terminada dentro de la historia en el componente y solo enviar la historia.
            // TODO Evitar que se modifique si ya ha sido terminada
            historiaNode.historia.terminada = e.detail.terminada;
            request.body = historiaNode.historia;
            request.generateRequest();

            request.addEventListener('error', function(e) {
                console.log('error');
                console.log(e);
            });

            request.addEventListener('response', function(e) {
                console.log('response');
                historiaNode.historia = e.detail.response;
            });
        });
    </script>
{% endblock js %}

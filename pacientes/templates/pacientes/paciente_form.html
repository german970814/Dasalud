{% extends "base.html" %}
{% load rest_framework i18n %}

{% block html_imports %}
    <link rel="import" href="/static/bower_components/paper-button/paper-button.html">
{% endblock html_imports %}

{% block css %}
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="/static/bower_components/mdl-stepper/stepper.min.css">
{% endblock css %}

{% block content %}

    <div class="card">
        <h1>{{ VERBO }} Paciente</h1>

        <form method="POST">
            {% csrf_token %}
            <ul class="mdl-stepper mdl-stepper--horizontal " id="demo-stepper-state-error">
            <li class="mdl-step mdl-step--editable">
                <span class="mdl-step__label">
                    <span class="mdl-step__title">
                        <span class="mdl-step__title-text">{% trans "Paciente" %}</span>
                        <span class="mdl-step__title-message">{% trans "Información general" %}</span>
                    </span>
                </span>
                <div class="mdl-step__content">
                    {% render_form paciente_s template_pack='material-pack' %}
                </div>
                <div class="mdl-step__actions">
                    <paper-button raised data-stepper-next>{% trans "Continuar" %}</paper-button>
                </div>
            </li>
            <li class="mdl-step mdl-step--editable">
                <span class="mdl-step__label">
                    <span class="mdl-step__title">
                        <span class="mdl-step__title-text">{% trans "Orden" %}</span>
                    </span>
                </span>
                <div class="mdl-step__content">
                    {% render_form orden_s template_pack='material-pack' %}
                </div>
                <div class="mdl-step__actions">
                    <paper-button raised data-stepper-next>{% trans "Continuar" %}</paper-button>
                    <paper-button raised data-stepper-back>{% trans "Atras" %}</paper-button>
                </div>
            </li>
            <li class="mdl-step mdl-step--editable">
                <span class="mdl-step__label">
                    <span class="mdl-step__title">
                        <span class="mdl-step__title-text">{% trans "Acompañante" %}</span>
                    </span>
                </span>
                <div class="mdl-step__content">
                    {% render_form acompanante_s template_pack='material-pack' %}
                </div>
                <div class="mdl-step__actions">
                    <paper-button raised data-stepper-next>{% trans "Terminar" %}</paper-button>
                    <paper-button raised data-stepper-back>{% trans "Atras" %}</paper-button>
                </div>
            </li>
            </ul>
        </form>

    </div>
{% endblock content %}

{% block js %}
    <script src="https://code.getmdl.io/1.1.3/material.min.js"></script>
    <script src="/static/bower_components/mdl-stepper/stepper.min.js"></script>
    <script>
        var stepperNode= document.querySelector('.mdl-stepper');
        var stepper;

        function getStepper() {
            if (!stepper) {
                stepper = stepperNode.MaterialStepper;
                console.log(stepper);
            }
        }

        // Check if MDL Component Handler is loaded.
        if (typeof componentHandler !== 'undefined') {
            // Get the MaterialStepper instance of element to control it.
            stepperNode.addEventListener('onstepnext', function(e) {
                getStepper();
                let activeStep = stepper.getActive();

                let valid = true;
                let content = activeStep.querySelector('.mdl-step__content');
                console.log(content.children);
                let children = content.children;
                for (let i=0; i < children.length; i++) {
                    let element = children[i];
                    try {
                        if (!element.validate()) valid = false;
                    } catch (error) {
                        // 
                    }
                }
                
                if (valid) { 
                    stepper.next();
                }
                else {
                    stepper.error("Hay errores en el formulario.");
                }
            })

            stepperNode.addEventListener('onstepback', function(e) {
                getStepper();
                stepper.back();
            });

            stepperNode.addEventListener('onsteppercomplete', function() {
                document.querySelector('form').submit();
            });

        } else {
            console.log("no encontrado");
            // Material Design Lite javascript is not loaded or for another  
            // reason MDL Component Handler is not available globally and
            // you can't use (register and upgrade) Stepper component at this point.
        }
    </script>
{% endblock js %}
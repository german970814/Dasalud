{% extends "base.html" %}
{% load rest_framework i18n static common_tags %}

{% block imports %}
    <link rel="import" href="/static/bower_components/paper-button/paper-button.html">
    <link rel="import" href="/static/bower_components/iron-form/iron-form.html">
    <link rel="import" href="/static/bower_components/paper-fab/paper-fab.html">
    <link rel="import" href="/static/bower_components/paper-icon-button/paper-icon-button.html">
    <link rel="import" href="/static/bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
    <link rel="import" href="/static/bower_components/paper-dialog/paper-dialog.html">
    <link rel="import" href="/static/bower_components/vaadin-grid/vaadin-grid.html">
    <link rel="import" href="/static/components/ig-iron-ajax.html">
    <link rel="import" href="/static/components/paciente-info.html">
    <link rel="import" href="/static/components/orden/servicios-orden.html">
    <link rel="import" href="/static/components/orden/servicios-orden2.html">
    <link rel="import" href="/static/components/orden/acompanante-form.html">
    <link rel="import" href="/static/components/orden/orden-form.html">
{% endblock imports %}

{% block css %}
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="/static/bower_components/mdl-stepper/stepper.min.css">
    <link rel='stylesheet' href='{% static "bower_components/fullcalendar/dist/fullcalendar.min.css" %}' />
    <custom-style>
        <style>
            .mdl-stepper {
                max-width: none;
                width: 100%;
            }

            #servicios .servicio {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            #servicios .servicio .container {
                display: flex;
                flex-wrap: wrap;
            }

            #servicios .servicio .container > * {
                margin-right: 20px;
            }

            .row {
                display: flex;
            }

            .row > * {
                flex: 1;
                margin-right: 10px;
            }

            .no-flex {
                flex: 0;
            }
        </style>
    </custom-style>
{% endblock css %}

{% block content %}
    <ig-iron-ajax id="request" method="POST" url="{% url 'pacientes:ordenes' paciente_id %}" 
        handle-as="json" content-type="application/json">
    </ig-iron-ajax>

    <div class="card">
        <div class="row">
            <paciente-info class="no-flex" flat paciente="{{ paciente }}"></paciente-info>
            <div>
                <orden-form instituciones='{{ orden_s.fields.institucion|to_json }}'
                    afiliaciones='{{ orden_s.fields.afiliacion|to_json }}'
                    tipos-usuario='{{ orden_s.fields.tipo_usuario|to_json }}'>
                </orden-form>
            </div>
        </div>
        <!-- <servicios-orden2></servicios-orden2> -->
        <servicios-orden></servicios-orden>
        <paper-button id="save">{% trans "Guardar" %}</paper-button>
    </div>
{% endblock content %}

{% block dialogs %}
    <paper-dialog>
        <div>
            {% trans "Debe agregar por lo menos un servicio." %}                
        </div>
        <div class="buttons">
            <paper-button  dialog-dismiss>{% trans "Cerrar" %}</paper-button>
        </div>
    </paper-dialog>
    <paper-dialog id="calendario" modal style="width: 75%; height: 90%;">
        <h2>{% trans "Citas" %}</h2>

        <div style="height: 80%">
            <div id="calendar"></div>
        </div>
        <div class="buttons">
            <paper-button dialog-dismiss>{% trans "Cerrar" %}</paper-button>
        </div>
    </paper-dialog>
{% endblock dialogs %}

{% block js %}
    <script>
        const request = document.getElementById('request');

        document.getElementById('save').addEventListener('click', function(e) {
            console.log(e);
            const ordenForm = document.querySelector('orden-form');
            const serviciosOrden = document.querySelector('servicios-orden');
            ordenForm.validate();
            // serviciosOrden.validate();

            let orden = serializeOrden(ordenForm.value, serviciosOrden.serialize());
            request.body = orden;
            request.generateRequest();
        });

        function serializeOrden(ordenData, serviciosData) {
            console.log(ordenData);
            let orden = {
                tipo_usuario: ordenData.tipoUsuario.value,
                institucion: ordenData.institucion.value,
                afiliacion: ordenData.afiliacion.value,
                plan: ordenData.plan.node.id,
                acompanante: {
                    asistio: ordenData.asistio,
                    nombre: ordenData.nombreCompleto,
                    direccion: ordenData.direccion,
                    telefono: ordenData.telefono
                },
                servicios_realizar: serviciosData
            }
            console.log(orden);
            return orden;
        }
    </script>

    <script src="{% static 'bower_components/jquery/dist/jquery.min.js' %}"></script>
    <script src="{% static 'bower_components/moment/min/moment.min.js' %}"></script>
    <script src="{% static 'bower_components/fullcalendar/dist/fullcalendar.min.js' %}"></script>
    <script src="{% static 'bower_components/fullcalendar/dist/locale/es.js' %}"></script>

    <script>
        const calendar = $('#calendar');
        const medicosNode = document.getElementById('medicos');
        const sucursalesNode = document.getElementById('sucursales');
        const citaDialog = document.getElementById('cita-dialog');
        const serviciosOrden = document.querySelector('servicios-orden');
        const calendarioDialog = document.getElementById('calendario');
        var medico = 0, sucursal = 0, servicio, sesion;
        let bEvent;

        calendar.fullCalendar({
            header: {
                'left': 'prev,next, today',
                'center': 'title',
                'right': 'agendaWeek,agendaDay'
            },
            height: 'parent',
            allDaySlot: false,
            slotLabelFormat: 'h(:mm)a',
            navLinks: true,
            selectable: true,
            eventSources: [
                {
                    url: '{% url "agenda:horario-atencion" %}',
                    headers: {ACCEPT: 'application/json'},
                    data: function() {
                        return dataEvents();
                    },
                    rendering: 'background'
                },
                {
                    url: '{% url "agenda:citas" %}',
                    headers: {ACCEPT: 'application/json'},
                    data: function() {
                        return dataEvents();
                    }
                }
            ],
            dayClick: function(date, jsEvent, view) {
                dayClick(date, jsEvent, view);
            },
            selectOverlap: function(event) {
                if (calendar.fullCalendar('getView').name != 'month') {
                    if (event.source.rendering == 'background') {
                        seleccionCita(event);
                    }
                }
            }
        });

        function dayClick(date, event, view) {
            if (view.name == 'month') {  // If click on month view change to agendaWeek on the day clicked
                calendar.fullCalendar('changeView', 'agendaWeek', date.format());
            }
        }

        serviciosOrden.addEventListener('open-calendar', function(e) {
            console.log(e);
            medico = e.detail.servicio.item.medico.value;
            sucursal = e.detail.sesion.item.sucursal.value;
            servicio = e.detail.servicio.index;
            sesion = e.detail.sesion.index;
            calendarioDialog.open();
            calendar.fullCalendar('refetchEvents');
        });

        function dataEvents() {
            return {
                medico: medico,
                sucursal: sucursal
            }
        }

        function seleccionCita(cita) {
            cita.fecha = cita.start.format('MM/DD/YYYY');
            cita.hora = cita.start.format('hh:mm A');
            serviciosOrden.updateCita(servicio, sesion, cita);
            calendarioDialog.close();
        }
    </script>
{% endblock js %}